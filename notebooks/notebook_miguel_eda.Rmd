---
title: "InstarcarT"
author: "Miguel"
date: "27/08/2021"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##
```{r message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(magrittr)
library(arules)
library(arulesViz)


# https://www.cienciadedatos.net/documentos/43_reglas_de_asociacion

options(scipen = 999, digits = 4)
windowsFonts("Roboto" = windowsFont("Roboto"))
source("../src/ggplot_custom_theme.R")

```


```{r message = FALSE}
load("../data/instcart_data_sample.RData")
```



```{r}
orders %>% glimpse()
order_products %>% glimpse()
product_catalog %>% glimpse()

```



```{r}
orders$order_hour_of_day <- as.numeric(orders$order_hour_of_day)
```

```{r warning=FALSE}
order_products %>% 
  left_join(product_catalog, by = "product_id") %>% 
    ggplot(aes(y = department)) +
    geom_bar(stat = 'count', fill = "#28FFBF") +
    labs(
      title =  "Productos comprados por departamento",
    ) +
    ylab("") +
    xlab("Número de productos") +
    coord_flip() +
    custom_style() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
```{r}
orders %>% 
  ggplot(aes(x = order_hour_of_day)) +
  geom_histogram(color = "#ffffff", fill = "#F43B86") +
  labs(
    title = "Distribución ordenes por horario"
  ) +
  ylab("") +
  custom_style()
```
```{r warnings=FALSE}
orders %>% 
  ggplot(aes(x = days_since_prior_order)) +
  geom_histogram(color = "#ffffff", fill = "#57CC99") +
  labs(
    title = "Distribución dias desde la ultima compra"
  ) +
  ylab("") +
  custom_style()
```


```{r warnings=FALSE, message=FALSE}
order_products %>% 
  group_by(order_id) %>% 
  summarise(total_items = last(add_to_cart_order)) %>% 
  ggplot(aes(x = total_items)) +
  geom_histogram(color = "#ffffff", fill = "#911F27") +
  labs(
    title = "Distribución total productos por orden"
  ) +
  ylab("") +
  custom_style()
```
```{r}
order_products %>% 
  group_by(product_id) %>% 
  summarize(count = n()) %>% 
  top_n(10, wt = count) %>%
  left_join(product_catalog,by="product_id") %>%
  arrange(desc(count)) 
```

## Reglas de asociacion - Preparacion de datos

```{r}
transactionsDF <- read.transactions(file = "../data/order_products_samples.csv",
                                   format = "single",
                                   sep = ",",
                                   header = TRUE,
                                   cols = c("order_id", "product_name"),
                                   rm.duplicates = TRUE)


```


```{r}
inspect(transactionsDF[1:5])
```
